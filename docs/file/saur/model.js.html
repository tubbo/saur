<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">saur/model.js | saur</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/tubbo/saur"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/application.js~Application.html">Application</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/controller.js~Controller.html">Controller</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/mailer.js~Mailer.html">Mailer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/model.js~Model.html">Model</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/routes.js~Routes.html">Routes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/task.js~Task.html">Task</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/view.js~View.html">View</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-validate">validate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-validates">validates</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-task">task</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-describe">describe</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#application">application</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/application/adapter.js~Adapter.html">Adapter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/application/cache.js~Cache.html">Cache</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/application/cache.js~MemoryCache.html">MemoryCache</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/application/cache.js~RedisCache.html">RedisCache</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/application/database.js~Database.html">Database</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/application/database.js~MysqlAdapter.html">MysqlAdapter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/application/database.js~PostgresAdapter.html">PostgresAdapter</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#application-initializers">application/initializers</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Assets">Assets</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-EnvironmentConfig">EnvironmentConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ForceSSL">ForceSSL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Logging">Logging</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ServeStaticFiles">ServeStaticFiles</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#application-middleware">application/middleware</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-AuthenticityToken">AuthenticityToken</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-CompileAssets">CompileAssets</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ContentSecurityPolicy">ContentSecurityPolicy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-CORS">CORS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-logger">logger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-MethodOverride">MethodOverride</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-MissingRoute">MissingRoute</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-OakCache">OakCache</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-SSLRedirect">SSLRedirect</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-StaticFiles">StaticFiles</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-timing">timing</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#cli">cli</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Generate">Generate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Migrate">Migrate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-New">New</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Run">Run</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#cli-generate">cli/generate</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-controller">controller</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mailer">mailer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-migration">migration</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-model">model</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-GenerateTemplate">GenerateTemplate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Test">Test</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-GenerateView">GenerateView</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#errors">errors</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/errors/missing-route.js~MissingRouteError.html">MissingRouteError</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#model">model</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/model/errors.js~Errors.html">Errors</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/model/migration.js~Migration.html">Migration</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/model/relation.js~Relation.html">Relation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/model/validations.js~GenericValidation.html">GenericValidation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/model/validations.js~Presence.html">Presence</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/model/validations.js~Validation.html">Validation</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#routes">routes</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/routes/helpers.js~RouteHelpers.html">RouteHelpers</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/routes/route-set.js~RouteSet.html">RouteSet</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/routes/route.js~Route.html">Route</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#view">view</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/saur/view/template.js~Template.html">Template</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">saur/model.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import reduce from &quot;https://deno.land/x/lodash/reduce.js&quot;;
import merge from &quot;https://deno.land/x/lodash/merge.js&quot;;
import each from &quot;https://deno.land/x/lodash/each.js&quot;;
import flatten from &quot;https://deno.land/x/lodash/flatten.js&quot;;
import Validations, { GenericValidation } from &quot;./model/validations.js&quot;;
import Errors from &quot;./model/errors.js&quot;;
import Relation from &quot;./model/query.js&quot;;

/**
 * Decorator for adding pre-defined validators to a model.
 *
 * @example
 *   import Model, { validates } from &quot;https://deno.land/x/saur/model.js&quot;;
 *   import { titleCase } from &quot;https://deno.land/std/case/mod.ts&quot;;
 *
 *   @validates(&quot;name&quot;, { presence: true })
 *   export default class YourModel extends Model {
 *      get title() {
 *        return titleCase(this.name)
 *      }
 *   }
 * @param string name - Name of the property
 * @param Object validations - Validations to add
 */
export function validates(name, validations = {}) {
  return (target) =&gt; target.validates(name, validations);
}

/**
 * Decorator for adding a custom validator to a model.
 *
 * @example
 *   import Model, { validate } from &quot;https://deno.land/x/saur/model.js&quot;;
 *
 *   @validate(&quot;nameNotFoo&quot;);
 *   export default class YourModel extends Model {
 *     nameNotFoo() {
 *       if (this.name === &quot;foo&quot;) {
 *          this.errors.add(&quot;name&quot;, &quot;cannot be foo&quot;);
 *       }
 *     }
 *   }
 * @param string method - Method name to run in validations.
 */
export function validate(method) {
  return (target) =&gt; target.validate(method);
}

export default class Model {
  /**
   * All validations on this model.
   */
  static validations = [];

  /**
   * Table name for this model.
   */
  static table = null;

  /**
   * A macro for creating a new `Validation` object in the list of
   * validations a model may run through. Call it with
   * `YourModelName.validates`.
   *
   * @param string name - Name of the property
   * @param Object validations - Validations to add
   */
  static validates(name, validations = {}) {
    each(validations, (options, name) =&gt; {
      const Validation = Validations[name];
      options = options === true ? {} : options;

      this.validations.push(new Validation(options));
    });
  }

  /**
   * A macro for creating a new `GenericValidation` object, allowing the
   * validation to consist of just running a method which may or may not
   * add errors. Call it with `YourModelName.validate`.
   *
   * @param string method - Name of the method to call
   */
  static validate(method) {
    this.validations.push(new GenericValidation({ method }));
  }

  /**
   * Create a new model record and save it to the database.
   */
  static create(attributes = {}) {
    const model = new this(attributes);
    model.save();
    return model;
  }

  /**
   * Return a relation representing all records in the database.
   */
  static get all() {
    return new Relation(this);
  }

  /**
   * Perform a query for matching models in the database.
   */
  static where(query) {
    return this.all.where(query);
  }

  /**
   * Find an existing model record in the database by the given
   * parameters.
   */
  static findBy(query) {
    return this.where(query).first;
  }

  /**
   * Find an existing model record in the database by its ID.
   */
  static find(id) {
    return this.findBy({ id });
  }

  constructor(attributes = {}) {
    this.attributes = attributes;
    this.errors = new Errors();
    this.initialize();
  }

  initialize() {}

  /**
   * All non-function properties of this object.
   */
  get attributes() {
    return reduce(
      this,
      (attrs, value, prop) =&gt; {
        if (typeof value !== &quot;function&quot;) {
          attrs[prop] = value;
        }

        return attrs;
      },
      {}
    );
  }

  /**
   * Set attributes on this object by assigning properties directly to
   * it.
   */
  set attributes(attrs = {}) {
    merge(this, attrs);
  }

  /**
   * Flatten validators from their method calls.
   */
  get validations() {
    return flatten(this.constructor.validations);
  }

  /**
   * Run all configured validators.
   */
  get valid() {
    this.validations.forEach((validation) =&gt; validation.valid(this));

    return this.errors.any;
  }

  /**
   * Persist the current information in this model to the database.
   */
  save() {
    if (!this.valid) {
      return false;
    }

    const query = new Relation(this);

    if (this.id) {
      query.where(&quot;id&quot;, this.id).update(this.attributes);
    } else {
      query.insert(this.attributes);
    }

    query.run();

    return true;
  }

  /**
   * Set the given attributes on this model and persist.
   */
  update(attributes = {}) {
    this.attributes = attributes;

    return this.save();
  }

  /**
   * Remove this model from the database.
   */
  destroy() {
    const query = new Relation(this);

    query.where(&quot;id&quot;, this.id).delete();
    query.run();

    return true;
  }

  /**
   * Reload this model&apos;s information from the database.
   */
  reload() {
    const model = this.constructor.find(this.id);

    merge(this, model.attributes);

    return this;
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
